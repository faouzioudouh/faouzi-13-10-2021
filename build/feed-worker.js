import _objectSpread from"/Users/faouzi.oudouh/Documents/projects/faouzi-13-10-2021/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2";import _classCallCheck from"/Users/faouzi.oudouh/Documents/projects/faouzi-13-10-2021/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck";import _createClass from"/Users/faouzi.oudouh/Documents/projects/faouzi-13-10-2021/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass";import _toConsumableArray from"/Users/faouzi.oudouh/Documents/projects/faouzi-13-10-2021/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray";import _slicedToArray from"/Users/faouzi.oudouh/Documents/projects/faouzi-13-10-2021/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray";var updateOrRemoveOrderbookLevels=function(e,r){return e.reduce((function(e,r){var t=_slicedToArray(r,2),o=t[0],s=t[1],a=e.find((function(e){return _slicedToArray(e,1)[0]===o}));return a&&0===s?e.filter((function(e){return e!==a})):a&&s>0?e.map((function(e){return e===a?r:e})):!a&&s>0?[].concat(_toConsumableArray(e),[r]):e}),r)},RealtimeFeed=function(){function e(){var r=this;_classCallCheck(this,e),this.websocket=null,this.updateInterval=500,this.ready=!1,this.currentProductsIds=[],this.rawOrderbook=null,this.currentInterval=0,this.realtimeFeedSource="",this._queue=[],this.init=function(){r.websocket=new WebSocket(r.realtimeFeedSource),r.websocket.onopen=function(){r.ready=!0,postMessage({type:"READY",data:!0}),r.executeQueue(),r.sendOrderbook()},r.websocket.onclose=function(){r.ready=!1,postMessage({type:"READY",data:!1}),setTimeout(r.init,1e3)},r.websocket.onerror=function(){r.ready=!1,postMessage({type:"READY",data:!1})},r.websocket.onmessage=r.onMessage},this.onMessage=function(e){var t=JSON.parse(e.data);if(["book_ui_1","book_ui_1_snapshot"].includes(t.feed)&&r.currentProductsIds.includes(t.product_id)){var o=t;if("book_ui_1_snapshot"===o.feed)r.rawOrderbook=o;else if("book_ui_1"===o.feed&&r.rawOrderbook){var s=updateOrRemoveOrderbookLevels(r.rawOrderbook.asks,o.asks),a=updateOrRemoveOrderbookLevels(r.rawOrderbook.bids,o.bids);r.rawOrderbook=_objectSpread(_objectSpread({},r.rawOrderbook),{},{asks:s,bids:a})}}},this.subscribeToFeed=function(e){r.unsubscribe();var t={event:"subscribe",feed:"book_ui_1",product_ids:e};r.currentProductsIds=e,r.queue=[JSON.stringify(t)]},this.unsubscribe=function(){if(r.currentProductsIds.length>0){var e={event:"unsubscribe",feed:"book_ui_1",product_ids:r.currentProductsIds};r.currentProductsIds=[],r.queue=[JSON.stringify(e)]}},this.executeQueue=function(){r.ready&&0!==r.queue.length&&(r.queue.forEach((function(e){var t;null===(t=r.websocket)||void 0===t||t.send(e)})),r._queue=[])},this.sendOrderbook=function(){r.currentInterval&&clearInterval(r.currentInterval),r.currentInterval=setInterval((function(){r.ready&&postMessage({type:"ORDERBOOK_UPDATE",data:r.rawOrderbook})}),r.updateInterval)}}return _createClass(e,[{key:"queue",get:function(){return this._queue},set:function(e){this._queue=[].concat(_toConsumableArray(this._queue),_toConsumableArray(e)),this.executeQueue()}}]),e}(),instance=new RealtimeFeed;onmessage=function(e){switch(e.data.type){case"INIT":instance.realtimeFeedSource=e.data.data.realtimeFeedSource,instance.updateInterval=e.data.data.updateInterval,instance.init();break;case"SUBSCRIBE":instance.subscribeToFeed(e.data.data.productsIds);break;case"UNSUBSCRIBE":instance.unsubscribe();break;default:console.error("Unknown event:",e)}};